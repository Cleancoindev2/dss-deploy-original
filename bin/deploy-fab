#!/usr/bin/env bash

# shellcheck source=bin/lib/common.sh
. "${LIB_DIR:-$(cd "${0%/*}/lib"&&pwd)}/common.sh"

export ETH_FROM=${ETH_FROM:-$(seth rpc eth_coinbase)}

dappBuild

export SETH_ASYNC=yes

ETH_NONCE=${ETH_NONCE:-$(seth nonce "$ETH_FROM")}
export ETH_NONCE

VAT_FABtx=$(dapp create VatFab) && ETH_NONCE=$((ETH_NONCE + 1))
JUG_FABtx=$(dapp create JugFab) && ETH_NONCE=$((ETH_NONCE + 1))
VOW_FABtx=$(dapp create VowFab) && ETH_NONCE=$((ETH_NONCE + 1))
CAT_FABtx=$(dapp create CatFab) && ETH_NONCE=$((ETH_NONCE + 1))
DAI_FABtx=$(dapp create DaiFab) && ETH_NONCE=$((ETH_NONCE + 1))
MCD_JOIN_FABtx=$(dapp create DaiJoinFab) && ETH_NONCE=$((ETH_NONCE + 1))
FLAP_FABtx=$(dapp create FlapFab) && ETH_NONCE=$((ETH_NONCE + 1))
FLOP_FABtx=$(dapp create FlopFab) && ETH_NONCE=$((ETH_NONCE + 1))
FLIP_FABtx=$(dapp create FlipFab) && ETH_NONCE=$((ETH_NONCE + 1))
SPOT_FABtx=$(dapp create SpotFab) && ETH_NONCE=$((ETH_NONCE + 1))
POT_FABtx=$(dapp create PotFab) && ETH_NONCE=$((ETH_NONCE + 1))
END_FABtx=$(dapp create EndFab) && ETH_NONCE=$((ETH_NONCE + 1))
PAUSE_FABtx=$(dapp create PauseFab) && ETH_NONCE=$((ETH_NONCE + 1))

export SETH_ASYNC=no

test "$(seth receipt "$VAT_FABtx" status)" -eq 0 && exit 1
test "$(seth receipt "$JUG_FABtx" status)" -eq 0 && exit 1
test "$(seth receipt "$VOW_FABtx" status)" -eq 0 && exit 1
test "$(seth receipt "$CAT_FABtx" status)" -eq 0 && exit 1
test "$(seth receipt "$DAI_FABtx" status)" -eq 0 && exit 1
test "$(seth receipt "$MCD_JOIN_FABtx" status)" -eq 0 && exit 1
test "$(seth receipt "$FLAP_FABtx" status)" -eq 0 && exit 1
test "$(seth receipt "$FLOP_FABtx" status)" -eq 0 && exit 1
test "$(seth receipt "$FLIP_FABtx" status)" -eq 0 && exit 1
test "$(seth receipt "$SPOT_FABtx" status)" -eq 0 && exit 1
test "$(seth receipt "$POT_FABtx" status)" -eq 0 && exit 1
test "$(seth receipt "$END_FABtx" status)" -eq 0 && exit 1
test "$(seth receipt "$PAUSE_FABtx" status)" -eq 0 && exit 1

VAT_FAB=$(seth receipt "$VAT_FABtx" contractAddress)
JUG_FAB=$(seth receipt "$JUG_FABtx" contractAddress)
VOW_FAB=$(seth receipt "$VOW_FABtx" contractAddress)
CAT_FAB=$(seth receipt "$CAT_FABtx" contractAddress)
DAI_FAB=$(seth receipt "$DAI_FABtx" contractAddress)
MCD_JOIN_FAB=$(seth receipt "$MCD_JOIN_FABtx" contractAddress)
FLAP_FAB=$(seth receipt "$FLAP_FABtx" contractAddress)
FLOP_FAB=$(seth receipt "$FLOP_FABtx" contractAddress)
FLIP_FAB=$(seth receipt "$FLIP_FABtx" contractAddress)
SPOT_FAB=$(seth receipt "$SPOT_FABtx" contractAddress)
POT_FAB=$(seth receipt "$POT_FABtx" contractAddress)
END_FAB=$(seth receipt "$END_FABtx" contractAddress)
PAUSE_FAB=$(seth receipt "$PAUSE_FABtx" contractAddress)

cat > "$ADDRESS_DIR/load-fab-$(seth chain)" << EOF
#!/bin/bash

# fab deployment on $(seth chain) from $(git rev-parse HEAD)
# $(date)

export VAT_FAB=$VAT_FAB
export JUG_FAB=$JUG_FAB
export VOW_FAB=$VOW_FAB
export CAT_FAB=$CAT_FAB
export DAI_FAB=$DAI_FAB
export MCD_JOIN_FAB=$MCD_JOIN_FAB
export FLAP_FAB=$FLAP_FAB
export FLOP_FAB=$FLOP_FAB
export FLIP_FAB=$FLIP_FAB
export SPOT_FAB=$SPOT_FAB
export POT_FAB=$POT_FAB
export END_FAB=$END_FAB
export PAUSE_FAB=$PAUSE_FAB
EOF

#!/usr/bin/env bash

# shellcheck source=bin/lib/common.sh
. "${LIB_DIR:-$(cd "${0%/*}/lib"&&pwd)}/common.sh"

export ETH_FROM=${ETH_FROM:-$(seth rpc eth_coinbase)}
export SOLC_FLAGS="--optimize"

dappBuild

# Check that all fabs are defined
{ test -z "$VAT_FAB"    || test -z "$JUG_FAB"     || test -z "$VOW_FAB" || \
  test -z "$CAT_FAB"    || test -z "$DAI_FAB"     || test -z "$MCD_JOIN_FAB" || \
  test -z "$FLAP_FAB"   || test -z "$FLOP_FAB"    || test -z "$FLIP_FAB" || \
  test -z "$SPOT_FAB"   || test -z "$POT_FAB"     || test -z "$END_FAB"  || \
  test -z "$PAUSE_FAB"; } && \
  exit 1

export ETH_NONCE=$(seth nonce $ETH_FROM)

# If no Governance token is defined, create one
test -z "$MCD_GOV" && MCD_GOV=$(dapp create DSToken "$(seth --to-bytes32 "$(seth --from-ascii "MKR")")") && ETH_NONCE="$(($ETH_NONCE + 1))"
export ETH_NONCE

# Create deploy contract
MCD_DEPLOY=$(dapp create DssDeploy "$VAT_FAB" "$JUG_FAB" "$VOW_FAB" "$CAT_FAB" "$DAI_FAB" "$MCD_JOIN_FAB" "$FLAP_FAB" "$FLOP_FAB" "$FLIP_FAB" "$SPOT_FAB" "$POT_FAB" "$END_FAB" "$PAUSE_FAB")
export ETH_NONCE="$(($ETH_NONCE + 1))"

# If no Authority is defined, create one
if [ -z "$MCD_ADM" ]
then
    MCD_ADM=$(dapp create DSRoles)
    export ETH_NONCE="$(($ETH_NONCE + 1))"
    seth send "$MCD_ADM" 'setRootUser(address,bool)' "$ETH_FROM" true
    export ETH_NONCE="$(($ETH_NONCE + 1))"
fi

# Deploy VAT
seth send "$MCD_DEPLOY" "deployVat()"
export ETH_NONCE="$(($ETH_NONCE + 1))"

# Deploy MCD
seth send "$MCD_DEPLOY" "deployDai(string memory,string memory,string memory,uint256)" "DAI" "Dai Stablecoin" "1" "$(seth rpc net_version)"
export ETH_NONCE="$(($ETH_NONCE + 1))"

# Deploy Taxation
seth send "$MCD_DEPLOY" "deployTaxationAndAuctions(address)" "$MCD_GOV"
export ETH_NONCE="$(($ETH_NONCE + 1))"

# Deploy Liquidation
seth send "$MCD_DEPLOY" "deployLiquidator()"
export ETH_NONCE="$(($ETH_NONCE + 1))"

# Deploy End
seth send "$MCD_DEPLOY" "deployEnd()"
export ETH_NONCE="$(($ETH_NONCE + 1))"

# Deploy pause
MCD_PAUSE_DELAY=${MCD_PAUSE_DELAY:-"3600"}
seth send "$MCD_DEPLOY" "deployPause(uint256,address)" "$(seth --to-uint256 "$MCD_PAUSE_DELAY")" "$MCD_ADM"
export ETH_NONCE="$(($ETH_NONCE + 1))"

cat > "$ADDRESS_DIR/load-mcd-$(seth chain)" << EOF
#!/bin/bash

# mcd deployment on $(seth chain) from $(git rev-parse HEAD)
# $(date)

export MCD_DEPLOY=$MCD_DEPLOY
export MCD_GOV=$MCD_GOV
export MCD_ADM=$MCD_ADM
export MCD_VAT=0x$(seth call "$MCD_DEPLOY" "vat()(address)")
export MCD_JUG=0x$(seth call "$MCD_DEPLOY" "jug()(address)")
export MCD_CAT=0x$(seth call "$MCD_DEPLOY" "cat()(address)")
export MCD_VOW=0x$(seth call "$MCD_DEPLOY" "vow()(address)")
export MCD_JOIN_DAI=0x$(seth call "$MCD_DEPLOY" "daiJoin()(address)")
export MCD_FLAP=0x$(seth call "$MCD_DEPLOY" "flap()(address)")
export MCD_FLOP=0x$(seth call "$MCD_DEPLOY" "flop()(address)")
export MCD_SPOT=0x$(seth call "$MCD_DEPLOY" "spotter()(address)")
export MCD_POT=0x$(seth call "$MCD_DEPLOY" "pot()(address)")
export MCD_END=0x$(seth call "$MCD_DEPLOY" "end()(address)")
export MCD_PAUSE=0x$(seth call "$MCD_DEPLOY" "pause()(address)")
export MCD_PAUSE_PROXY=0x$(seth call "0x$(seth call "$MCD_DEPLOY" "pause()(address)")" "proxy()(address)")
export MCD_DAI=0x$(seth call "$MCD_DEPLOY" "dai()(address)")
EOF
